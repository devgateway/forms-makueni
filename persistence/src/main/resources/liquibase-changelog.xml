<!--
    Copyright (c) 2015 Development Gateway, Inc and others.

    All rights reserved. This program and the accompanying materials
    are made available under the terms of the MIT License (MIT)
    which accompanies this distribution, and is available at
    https://opensource.org/licenses/MIT

    Contributors:
    Development Gateway - initial API and implementation
-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="add-default-group" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="group1"/>
            <column name="DTYPE" value="Group"/>
        </insert>
    </changeSet>

    <changeSet id="add-default-roles" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="ROLE"/>
        </preConditions>
        <insert tableName="ROLE">
            <column name="ID" value="1"/>
            <column name="AUTHORITY" value="ROLE_USER"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" value="2"/>
            <column name="AUTHORITY" value="ROLE_ADMIN"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" value="3"/>
            <column name="AUTHORITY" value="ROLE_VALIDATOR"/>
        </insert>
    </changeSet>

    <changeSet id="7" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PERSON_ROLES"/>
            <tableExists tableName="ROLE"/>
            <tableExists tableName="PERSON"/>
        </preConditions>
        <sqlFile path="Person.sql"/>
    </changeSet>

    <changeSet id="8" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PERSON_ROLES"/>
            <tableExists tableName="ROLE"/>
            <tableExists tableName="PERSON"/>
        </preConditions>
        <sqlFile path="Person_roles.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-14" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Office of the Governor"/>
            <column name="CODE" value="D1"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Public Service Board"/>
            <column name="CODE" value="D2"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Makueni County Service (County Secretary)"/>
            <column name="CODE" value="D3"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Devolution, County Administration, Participatory Development and Public Service"/>
            <column name="CODE" value="D4"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Finance and Social Economic Planning"/>
            <column name="CODE" value="D5"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Agriculture, Irrigation, Livestock and Fisheries Development"/>
            <column name="CODE" value="D6"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Water, Sanitation, Environment and Climate Change"/>
            <column name="CODE" value="D7"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Education, Youth, Sports and ICT"/>
            <column name="CODE" value="D8"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Health Services"/>
            <column name="CODE" value="D9"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Lands, Mining, Housing, Physical Planning and Urban Development"/>
            <column name="CODE" value="D10"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Roads, Transport, Energy and Public Works"/>
            <column name="CODE" value="D11"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Trade, Industry, Marketing, Tourism and Co-operative Development"/>
            <column name="CODE" value="D12"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Gender, Children, Culture and Social Services"/>
            <column name="CODE" value="D13"/>
            <column name="DTYPE" value="Department"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-13" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Direct"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Open tender national"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="RF proposal"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="RFQ"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Restricted tender"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Special permitted"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Low value procurement"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Open tender International"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-17" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Youth"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Women"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="PWD"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Citizen Contractor"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Margin of Preference for Local Contractor"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-35" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Development"/>
            <column name="DTYPE" value="ChargeAccount"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Recurrent"/>
            <column name="DTYPE" value="ChargeAccount"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-34" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Tender Form and Price schedule"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Schedule of Requirements"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Details of Cover"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Conditions of the Contract"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Special Conditions of Contract"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Procuring Entity Notification of Award"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-37" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Items.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-117" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Metadata1.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-117-staff" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Metadata2.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-181" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kaiti"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kibwezi East"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kibwezi West"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kilome"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Makueni"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Mbooni"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-180" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
            <columnExists tableName="category" columnName="subcounty_id"/>
        </preConditions>
        <sqlFile path="Wards.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-177-1" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="tender_item"/>
            <tableExists tableName="tender_item_aud"/>
            <columnExists tableName="tender_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table tender_item alter column quantity type double precision</sql>
        <sql>alter table tender_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-177-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="plan_item"/>
            <tableExists tableName="plan_item_aud"/>
            <columnExists tableName="plan_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table plan_item alter column quantity type double precision</sql>
        <sql>alter table plan_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-177-3" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purchase_item"/>
            <tableExists tableName="purchase_item_aud"/>
            <columnExists tableName="purchase_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table purchase_item alter column quantity type double precision</sql>
        <sql>alter table purchase_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-333" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="person_departments"/>
        </preConditions>
        <sql>
            insert into person_departments (select id, department_id from person where department_id is not null);
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-382-1" author="mpostelnicu">
        <sql>
            ALTER TABLE public.purchase_requisition RENAME TO tender_process;
            ALTER TABLE public.purchase_requisition_aud RENAME TO tender_process_aud;
            ALTER TABLE public.purchase_requisition_form_docs RENAME TO tender_process_form_docs;
            ALTER TABLE public.purchase_requisition_status_comments RENAME TO tender_process_status_comments;
            ALTER TABLE public.purchase_requisition_purchase_item_aud RENAME TO tender_process_purchase_item_aud;
            ALTER TABLE public.tender RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_quotation_evaluation RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.professional_opinion RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.award_notification RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.award_acceptance RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.contract RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_process_status_comments RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_process_form_docs RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.purchase_item RENAME TO old_purchase_item;
            ALTER TABLE public.purchase_item_aud RENAME TO old_purchase_item_aud;
            DROP INDEX "idx4crx1on2q7qknriounxm5p330";
            DROP INDEX "idxjv3kypsec7o8b1juvyk2dj9mn";
            DROP INDEX "idxsfo7avbdcooxih398oabhbdau";
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-382-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purch_requisition"/>
        </preConditions>
        <sql>
            insert into purch_requisition (id, "index", charge_account_id, created_by, created_date, last_modified_by,
            last_modified_date,
            parent_id, request_approval_date, requested_by_id)
            (select nextval('hibernate_sequence'),0, t.charge_account_id, t.created_by, t.created_date,
            t.last_modified_by,
            t.last_modified_date, t.id, t.request_approval_date, t.requested_by_id from tender_process t);
            insert into purch_requisition_form_docs (purch_requisition_id, form_docs_id)
            (select pr.id, tp.form_docs_id from tender_process_form_docs tp, purch_requisition pr where pr.parent_id =
            tp.tender_process_id);
            drop table tender_process_form_docs;
            insert into purchase_item (id, created_by, created_date, last_modified_by, last_modified_date, amount,
            description, quantity,
            parent_id, plan_item_id, index)
            (select o.id, o.created_by, o.created_date, o.last_modified_by, o.last_modified_date,
            o.amount, o.description, o.quantity, pr.id , o.plan_item_id, o."index"
            from old_purchase_item o, tender_process p, purch_requisition pr where o.parent_id=p.id
            and pr.parent_id = p.id);
            alter table tender_item DROP CONSTRAINT "fkl61vasyq7qrwegdguaqqrt97v";
            drop table old_purchase_item;
        </sql>
    </changeSet>
</databaseChangeLog>
